# Capturing color data from display

0. Need to acquire ArgyllCMS, which is the software we use to capture color data. Note that there is a bug in the release version on Mac OS that prevents saving of large ti3 files. Compililng from source in Debug mode seems to be a workaround.
1. Need file ```targ_256ramps_0ofps_11bw.ti1```. This contains a list of colors that you want to sample (787 of them). This has all colors of red (0 to 255), blue, and green, for a total of 256*3 = 768. The remaining samples should be repeated samplings of white and black. If you want a different color set measured you can use the ```targen``` program.
2. To collect the data, use the ```dispread``` program.  I used the following command line: ```./dispread -v -d 2 -s -H targ_256ramps_0ofps_11bw```
3. This will read the .ti1 file and produce a .ti3 file ... may take about an hour to run, may require intervention if there is a calibration error during the run. I also recommend turning off the lights int he room to avoid the possbility that light from the room will reflect off the display and into the measurement device.
4. The .ti3 file will contain the various color measurements and spectra for each sample.
5. Consistency check: The spectrum for white should be equal to the sum of the spectrum for 255 red + 255 green + 255 blue. If it is far off from that you may have trouble that you need to investigate further.
6. To produce a gamma lookup table, do the following: Create a column in the spreadsheet that is the total energy of each spectrum (so just sum up all spectral values). Put the red samples, green samples, and blue samples in separate sheets. Find the max value for each and define it to be 1.0. Then just divide the rest of the values by that max value to get the values for the other colors. See the example spreadsheet for a sample. It may be desirable to do the data capture multiple times and then do some outlier removal + averaging to get usable values.
7. To produce XYZ to RGB and RGB to XYZ conversion matrices, you will need the XYZ primaries from http://www.cvrl.org/ciexyzpr.htm. Let R, G, and B denote the color primaries of your display (the spectra that you measured for max red, max green, and max blue). For each (x, y) in {X, Y, Z} x {R, G, B}, do a convolution of x with y, to give C_xy. This gives you the amount of x in y (or vice versa). To convert XYZ to RGB, note that ```R = X*C_XR + Y*C_YR + Z*C_ZR``` (and so on for G and B). These values may need to be normalized ... it is useful to know the XYZ value of brightest white on your display for this purpose.
8. Once you have the .ti3 file, you can import it into Excel, and it will do a nice job of splitting it into columns (you may need to fiddle with the import settings to get a behavior that you will like). Import as text, pick delimited, select space and tab for delimeters.
9. Goal is to produce 3 files:
  1. gamma.csv (column 1 is number from 0 to 255, column 2 is that number converted to float by dividing by 255.0, column 3 is uncompressed version)
  2. primaries.csv (row 1 is labels, row 2 is R primary, row 3 is G primary, row 4 is B primary, row 5 is spectrum of white)
  3. matrices.csv (First 4 rows are RGB to XYZ matrix, next 4 are XYZ to RGB)